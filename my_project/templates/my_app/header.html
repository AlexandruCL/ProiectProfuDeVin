{% load static %}
{% load custom_filters %}

<header class="site-header">
    <div class="site-container site-container-fluid">
        <nav class="site-header-inner" aria-label="Primary">
            <div class="site-header-left" aria-label="Brand">
                <a class="site-brand" href="/home" aria-label="Home">
                    <img src="{% static 'images/logo.png' %}" alt="Profu De' Vin" />
                    <span class="site-brand-text">Profu' De Vin</span>
                </a>
            </div>

            <div class="site-header-center desktop-only" aria-label="Primary links">
                <div class="site-navlinks">
                    <a href="/home" class="site-link">Home</a>
                    <a href="/home/product_list" class="site-link">Product List</a>
                    <a href="/home/contact" class="site-link">Contact</a>

                </div>
            </div>

            <div class="site-header-right" aria-label="Account and actions">
                <div class="site-navlinks desktop-only">
                    {% if user.is_authenticated %}
                        <a href="{% url 'profile_view' %}" class="site-link">Welcome, {{ user.username }}</a>
                        {% if user.is_superuser or user|has_group:"Product Population" %}
                            <a href="{% url 'admin_dashboard' %}" class="site-link">Admin Dashboard</a>
                        {% endif %}
                        <a href="{% url 'cart_view' %}" class="site-link site-cart" aria-label="Cart">
                            <span class="site-cart-logo" aria-hidden="true"></span>
                            <span class="site-cart-count cart-count">{{ cart_item_count }}</span>
                        </a>
                        <a href="{% url 'logout_view' %}?next={{ request.path }}" class="site-link" id="logout-link">Log out</a>
                    {% else %}
                        <a href="{% url 'login' %}?next={{ request.path }}" class="site-link">Log in</a>
                        <a href="{% url 'signup' %}?next={{ request.path }}" class="site-link">Sign up</a>
                    {% endif %}
                </div>

                <button class="site-mobile-button" type="button" id="mobile-menu-button" aria-controls="mobile-menu" aria-expanded="false" aria-label="Open menu">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
            </div>
        </nav>
    </div>

    <div id="mobile-menu" class="site-mobile-panel" aria-label="Mobile menu">
        <a href="/home" class="site-link">Home</a>
        <a href="/home/contact" class="site-link">Contact</a>
        <a href="/home/product_list" class="site-link">Product List</a>

        <hr style="border-color: rgba(255, 255, 255, 0.15); margin: 0.6rem 0;" />

        {% if user.is_authenticated %}
            <a href="{% url 'profile_view' %}" class="site-link">Welcome, {{ user.username }}</a>
            {% if user.is_superuser or user|has_group:"Product Population" %}
                <a href="{% url 'admin_dashboard' %}" class="site-link">Admin Dashboard</a>
            {% endif %}
            <a href="{% url 'cart_view' %}" class="site-link">Cart ({{ cart_item_count }})</a>
            <a href="{% url 'logout_view' %}?next={{ request.path }}" class="site-link" id="logout-link-mobile">Log out</a>
        {% else %}
            <a href="{% url 'login' %}?next={{ request.path }}" class="site-link">Log in</a>
            <a href="{% url 'signup' %}?next={{ request.path }}" class="site-link">Sign up</a>
        {% endif %}
    </div>

    <div id="custom-logout-dialog" class="site-dialog hidden" role="dialog" aria-modal="true" aria-label="Confirm logout">
        <p style="margin: 0 0 0.75rem;">Are you sure you want to log out?</p>
        <div class="site-dialog-actions">
            <button id="confirm-logout" type="button">Yes</button>
            <button id="cancel-logout" type="button">No</button>
        </div>
    </div>
</header>

<script>
    (function() {
        const menuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const logoutLink = document.getElementById('logout-link');
        const logoutLinkMobile = document.getElementById('logout-link-mobile');
        const dialog = document.getElementById('custom-logout-dialog');
        const confirmBtn = document.getElementById('confirm-logout');
        const cancelBtn = document.getElementById('cancel-logout');

        function toggleMobileMenu(force) {
            const isOpen = typeof force === 'boolean' ? force : !mobileMenu.classList.contains('is-open');
            mobileMenu.classList.toggle('is-open', isOpen);
            menuButton.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        }

        if (menuButton && mobileMenu) {
            menuButton.addEventListener('click', function() {
                toggleMobileMenu();
            });
        }

        function openLogoutDialog(event) {
            event.preventDefault();
            dialog.classList.remove('hidden');
            toggleMobileMenu(false);
        }

        if (logoutLink) logoutLink.addEventListener('click', openLogoutDialog);
        if (logoutLinkMobile) logoutLinkMobile.addEventListener('click', openLogoutDialog);

        if (confirmBtn) {
            confirmBtn.addEventListener('click', function() {
                const href = (logoutLink || logoutLinkMobile).href;
                window.location.href = href;
            });
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', function() {
                dialog.classList.add('hidden');
            });
        }

        document.addEventListener('click', function(event) {
            if (mobileMenu && menuButton && mobileMenu.classList.contains('is-open')) {
                const clickedMenu = mobileMenu.contains(event.target);
                const clickedButton = menuButton.contains(event.target);
                if (!clickedMenu && !clickedButton) {
                    toggleMobileMenu(false);
                }
            }

            if (dialog && !dialog.classList.contains('hidden')) {
                const clickedDialog = dialog.contains(event.target);
                const clickedLogoutDesktop = logoutLink && logoutLink.contains(event.target);
                const clickedLogoutMobile = logoutLinkMobile && logoutLinkMobile.contains(event.target);

                if (!clickedDialog && !clickedLogoutDesktop && !clickedLogoutMobile) {
                    dialog.classList.add('hidden');
                }
            }
        });
    })();
</script>